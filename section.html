<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Amateur Radio Practice Test
 * (yes I know, really generic name, come up with a better one later?)
 * http://github.com/odysseus654/amtest
 * Copyright 2012 Erik Anderson
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *-->
<html><head>
	<link rel="stylesheet" type="text/css" href="css/amtest.css" />
	<link rel="stylesheet" type="text/css" href="css/tristate.css" />
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="lib/tristate.js"></script>
	<script type="text/javascript" src="lib/questions.js"></script>
	<script type="text/javascript">
		function onExpandSection(secId, suppressSection)
		{
			var targets = $('TABLE.sec-choice TR.subof-'+secId);
			var ourRow = $(this).parents('TR');
			if(ourRow.hasClass('collapsed'))
			{
				ourRow.removeClass('collapsed');
				targets.removeClass(suppressSection);
			} else {
				ourRow.addClass('collapsed');
				targets.addClass(suppressSection);
			}
		}
		
		function onExpandSubsection(secId, suppressSection, questionState, subqlist)
		{
			// handle existing secttions
			var targets = $('TABLE.sec-choice TR.subof-'+secId);
			var ourRow = $(this).parents('TR');
			if(ourRow.hasClass('collapsed'))
			{
				ourRow.removeClass('collapsed');
				targets.removeClass(suppressSection);
				
				if(!targets.length)
				{
					// create the section if it doesn't already exist
					var detailRow = $('<tr/>',{'class':'questsection'})
						.addClass('subof-' + secId)
						.addClass('subof-' + secId.substr(0, 2))
						.append($('<td/>'))
						.append($('<td/>'))
						.insertAfter(ourRow);
					var questBlock = $('<td/>')
						.appendTo(detailRow);
					
					var detailCollection = $();
					for(var qidx=0; qidx < subqlist.length; qidx++)
					{
						var questObj = subqlist[qidx];
						var qobj = $('<span/>',{'class':'question',title:questObj.descr})
							.text(questObj.name)
							.appendTo(questBlock);
						
						new CategoryCheckbox({
							box: qobj.get(0),
							questionState: questionState,
							questId: questObj.name,
							state: questionState[questObj.name]
						});
						detailCollection = detailCollection.add(qobj);
					}
					$('SPAN.tristate', ourRow).triggerHandler('addChildren', {children:detailCollection});
				}
			} else {
				ourRow.addClass('collapsed');
				targets.addClass(suppressSection);
			}
		}
		
		function CategoryCheckbox(params)
		{
			this.questionState = params.questionState;
			this.questId = params.questId;
			var isChecked = false;
			var isUnchecked = false;
			for(var id in this.questionState)
			{
				if(id.substring(0, this.questId.length) == this.questId)
				{
					if(this.questionState[id])
					{
						isChecked = true;
					} else {
						isUnchecked = true;
					}
				}
			}
			params.state = isChecked && isUnchecked ? undefined : isChecked;
			TriStateCheckBox.call(this, params);
			if(!this.numQuestions) this.pullStateFromChildren();
		}
		CategoryCheckbox.prototype = new TriStateCheckBox();
		
		CategoryCheckbox.prototype.setState = function(state)
		{
			TriStateCheckBox.prototype.setState.call(this, state);
			var numQuestionsSelected = this.numQuestionsSelected;
			switch(state)
			{
				case TriStateCheckBox.STATE_ALL:
					numQuestionsSelected = this.numQuestions;
					break;
				case TriStateCheckBox.STATE_NONE:
					numQuestionsSelected = 0;
					break;
			}
			if(numQuestionsSelected !== this.numQuestionsSelected)
			{
				var ourRow = $('SPAN.qcount', $(this.triStateBox).parents('TR'));
				if(ourRow.length)
				{
					if(numQuestionsSelected == this.numQuestions)
					{
						ourRow.text(' (' + this.numQuestions + ' questions selected)');
					} else {
						ourRow.text(' (' + numQuestionsSelected + ' of ' + this.numQuestions + ' questions selected)');
					}
				}
				this.numQuestionsSelected = numQuestionsSelected;
			}
		};
		
		CategoryCheckbox.prototype.pullStateFromChildren = function(bForce)
		{
			var anyBoxes = false;
			var allBoxesSelected = true;
			var allBoxesUnselected = true;
			var numQuestions = 0;
			var numQuestionsSelected = 0;
			for(var id in this.questionState)
			{
				if(id.substring(0, this.questId.length) == this.questId)
				{
					anyBoxes = true;
					numQuestions++;
					if(this.questionState[id])
					{
						allBoxesUnselected = false;
						numQuestionsSelected++;
					} else {
						allBoxesSelected = false;
					}
				}
			}
			if(numQuestionsSelected !== this.numQuestionsSelected)
			{
				var ourRow = $('SPAN.qcount', $(this.triStateBox).parents('TR'));
				if(ourRow.length)
				{
					if(numQuestionsSelected == numQuestions)
					{
						ourRow.text(' (' + numQuestions + ' questions selected)');
					} else {
						ourRow.text(' (' + numQuestionsSelected + ' of ' + numQuestions + ' questions selected)');
					}
				}
				this.numQuestionsSelected = numQuestionsSelected;
				this.numQuestions = numQuestions;
			}
			
			var state = this.state;
			if(anyBoxes)
			{
				state = allBoxesSelected ? TriStateCheckBox.STATE_ALL :
					allBoxesUnselected ? TriStateCheckBox.STATE_NONE :
					TriStateCheckBox.STATE_SOME;
			}
			if(this.state != state || bForce)
			{
				this.state = state;
				this.updateImageState();
			}
		};

		CategoryCheckbox.prototype.updateImageState = function()
		{
			TriStateCheckBox.prototype.updateImageState.call(this);
			if(this.questId.length > 2)
			{
				switch(this.state)
				{
					case TriStateCheckBox.STATE_ALL:
						this.flagQuestions(true);
						break;
					case TriStateCheckBox.STATE_NONE:
						this.flagQuestions(false);
						break;
				}
			}
		};
		
		CategoryCheckbox.prototype.flagQuestions = function(checked)
		{
			for(var id in this.questionState)
			{
				if(id.substring(0, this.questId.length) == this.questId)
				{
					this.questionState[id] = checked;
				}
			}
		};
		
		$(document).ready(function()
		{
			$.ajax({
				url:'tests/extra08.json',
				dataType:'json',
				success:function(data)
				{
					fixupQuestions(data);
					var qlBase = $('<div/>',{'class':'main-body'})
						.appendTo(document.body);
					
					var secCheck = {};
					var secList = [];
					var questionState = {};
					for(var id in data.questions)
					{
						var twoChar = id.substring(0,2);
						if(!secCheck[twoChar])
						{
							secCheck[twoChar] = data.headers[twoChar];
							secList.push({name:twoChar,descr:data.headers[twoChar]});
						}
						secCheck[id.substring(0,3)] = data.headers[id.substring(0,3)];
						questionState[id] = true;
					}
					secList.sort(qsorter);
					
					var tableObj = $('<tbody/>')
						.appendTo($('<table/>',{'class':'sec-choice'})
							.appendTo(qlBase));
					
					var globalRow = $('<tr/>',{'class':'global'})
						.append($('<td/>',{colspan:3})
							.text('Check / Uncheck All')
							.append($('<span class="qcount"></span>')))
						.appendTo(tableObj);
					
					var secCollection = $();
					for(var sec=0; sec < secList.length; sec++)
					{
						var secObj = secList[sec];
						var subList = [];
						for(var id in secCheck)
						{
							if(id.length == 3 && id.substring(0, 2) == secObj.name)
							{
								subList.push({name:id,descr:secCheck[id]});
							}
						}
						var secRow = $('<tr/>',{'class':'section collapsed'})
							.append($('<td/>',{'class':'name'})
								.text(secObj.name)
								.prepend($('<span/>',{'class':'expander'})))
							.append($('<td/>',{colspan:2,'class':'descr'})
								.text(secObj.descr)
								.append($('<span class="qcount"></span>')))
							.appendTo(tableObj);
						
						$('SPAN.expander', secRow).on('click', curry(onExpandSection, secObj.name, 'sec-hidden'));
						
						subList.sort(qsorter);
						var subCollection = $();
						for(var sub=0; sub < subList.length; sub++)
						{
							var subObj = subList[sub];
							var subqlist = [];
							for(var id in data.questions)
							{
								if(id.substring(0, 3) == subObj.name)
								{
									subqlist.push({name:id,descr:data.questions[id].q});
								}
							}
							var subRow = $('<tr/>',{'class':'subsection collapsed sec-hidden'})
								.addClass('subof-' + secObj.name)
								.append($('<td/>'))
								.append($('<td/>',{'class':'name'})
									.text(subObj.name)
									.prepend($('<span/>',{'class':'expander'})))
								.append($('<td/>',{'class':'descr'})
									.text(subObj.descr)
									.append($('<span class="qcount"></span>')))
								.appendTo(tableObj);
							
							subqlist.sort(qsorter);
							$('SPAN.expander', subRow).on('click',
								curry(onExpandSubsection, subObj.name, 'sub-hidden', questionState, subqlist));
							
							new CategoryCheckbox({
								box: $($('TD', subRow).get(1)),
								questionState: questionState,
								questId: subObj.name
							});
							subCollection = subCollection.add(subRow);
						}
						
						new CategoryCheckbox({
							box: $($('TD', secRow).get(0)),
							children: subCollection,
							questionState: questionState,
							questId: secObj.name
						});
						secCollection = secCollection.add(secRow);
					}
					
					new CategoryCheckbox({
						box: $($('TD', globalRow).get(0)),
						children: secCollection,
						questionState: questionState,
						questId: ''
					});
				}
			});
		});
	</script>
</head>
<body>
</body>
</html>